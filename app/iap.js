// MARK: - The data object for all the iap products
// window.iapProducts = [{title: '高端会员',description: '<p>All the benefits of a Standard FT Subscription, plus exclusive news and analysis</p><p>Mobile and tablet access via our award-winning apps</p><p>Exclusive access to the Lex Column, and Instant Insight for comment and analysis as news unfolds</p>',price: '￥1,298.00',id: 'com.ft.ftchinese.mobile.subscription.premium',image: 'http://i.ftimg.net/picture/6/000068886_piclink.jpg', teaser: '注册成为高端会员', isPurchased: true, isDownloaded: false, group: 'membership', groupTitle: '会员',benefits:['All the benefits of a Standard FT Subscription, plus exclusive news and analysis','Mobile and tablet access via our award-winning apps','FT Confidential Research - in-depth China and Southeast Asia analysis'],period:'year'},{title: '普通会员',description: '<p>Unlimited access to all Standard-access articles and blogs</p><p>Mobile and tablet access via our award-winning apps</p><p>Personalised email briefings and alerts</p><p>Portfolio tools to track your investments</p>',price: '￥648.00',id: 'com.ft.ftchinese.mobile.subscription.standard',image: 'http://i.ftimg.net/picture/6/000068886_piclink.jpg', teaser: '注册成为普通会员', isPurchased: false, isDownloaded: false, group: 'membership', groupTitle: '会员',benefits:['Unlimited access to all Standard-access articles and blogs','Mobile and tablet access via our award-winning apps','Personalised email briefings and alerts'],period:'year'},{title: '试用会员',description: '<p>Unlimited access to all Standard-access articles and blogs for a month.</p>',price: '￥233.00',id: 'com.ft.ftchinese.mobile.subscription.trial',image: 'http://i.ftimg.net/picture/6/000068886_piclink.jpg', teaser: '注册成为试读会员', isPurchased: true, isDownloaded: false, group: 'membership', groupTitle: '会员',benefits:['benefit 1','benefit 2','benefit 3'],expire:'2017年04月22日',period:'month'},{title: 'FT研究院',description: '<p>管窥蠡测，以知一叶之秋。基于百万读者的大样本调研数据，同时广泛汲取公开数据资源，《FT研究院》专注热点财经问题及重要行业发展趋势的研究，致力于为广大读者提供贴近商业实况的前瞻性分析与洞察。</p>',price: '￥78.00',id: 'com.ft.ftchinese.mobile.subscription.intelligence3',image: 'http://i.ftimg.net/picture/3/000068413_piclink.jpg', teaser: '中国商业和消费数据', isPurchased: false, isDownloaded: false, group: 'subscription', groupTitle: '订阅',period:'year'},{title: '精选2016，展望2017',description: '<p>2016年，国际政坛波诡云谲，黑天鹅事件频发；中国经济热点频现，争论不休；中国人最牵挂的楼市、股市、外汇市场，经历了怎样的波动？对家庭资产造成了怎样的影响；中国互联网和新兴科技行业，可以同时看到未来和过去的影子……是什么在扇动黑天鹅们的翅膀？2017年，我们熟挂的楼市、股市、外汇市场，经历了怎样的波动？对家庭资产造成了怎样的影响；中国互联网和新兴科技行业，可以同时看到未来和过去的影子……是什么在扇动黑天鹅们的翅膀？2017年，我们熟悉的那个世界是否正在远去？中国又该如何应对？英国《金融时报》编辑精选中国经济、中国与世界、媒体与社交媒体、生活话题、公共政策、互联网与创新经济、国际话题、投资与财富管理，挂的楼市、股市、外汇市场，经历了怎样的波动？对家庭资产造成了怎样的影响；中国互联网和新兴科技行业，可以同时看到未来和过去的影子……是什么在扇动黑天鹅们的翅膀？2017年，我们熟悉的那个世界是否正在远去？中国又该如何应对？英国《金融时报》编辑精选中国经济、中国与世界、媒体与社交媒体、生活话题、公共政策、互联网与创新经济、国际话题、投资与财富管理，等领域的必读文章，进行深入解读，希望可以帮助读者预判未来走势。</p>',price: '￥18.00',id: 'com.ft.ftchinese.mobile.book.OutlookoftheFutureof2017',image: 'http://i.ftimg.net/picture/9/000068669_piclink.jpg', teaser: ' 2017年，我们熟悉的那个世界是否正在远去？', isPurchased: true, isDownloaded: true, group: 'ebook', groupTitle: 'FT电子书'},{title: '与FT共进午餐（一）',description: '<p>英国《金融时报》的“Lunch with the FT”栏目诞生于1994年，邀请各界人士在餐桌上向FT敞开心扉，谈论美食、爱好、家庭，展露他们职业生涯之外更真实的生活状态，迄今已经采访了800多人，可谓一卷丰富多彩的人物志。</p><p>在第一辑中您将看到对比尔·盖茨、诺奖得主尤努斯，郭广昌等各领域知名人士的采访。</p>',price: '￥12.00',id: 'com.ft.ftchinese.mobile.book.lunch1',image: 'http://i.ftimg.net/picture/2/000068702_piclink.jpg', teaser: '英国《金融时报》最受欢迎的栏目', isPurchased: true, isDownloaded: true, group: 'ebook', groupTitle: 'FT电子书'},{title: '与FT共进午餐（二）',description: '<p>《与FT共进午餐》多年来都是FT周末版最受欢迎的栏目之一。</p><p>精英名流们在餐桌上向FT敞开心扉，谈论美食、爱好、家庭，展露他们职业生涯之外更真实的生活状态。</p><p>采访过程也很独特——由被采访对象指定餐厅，餐后由FT付账，或奢或俭，文章末尾都会列出菜单和价格。</p><p>总之。《与FT共进午餐》是FT上最有看头的栏目。</p><p>在这期您将看到我们采访：奥沙利文、郎朗、安吉丽娜·朱莉等各领域知名人物。</p>',price: '￥12.00',id: 'com.ft.ftchinese.mobile.book.lunch2',image: 'http://i.ftimg.net/picture/3/000068703_piclink.jpg', teaser: '英国《金融时报》最受欢迎的栏目', isPurchased: true, isDownloaded: true, group: 'ebook', groupTitle: 'FT电子书'}];
// MARK: - The HTML template for iap channel pages like eBook store or subscription center, so that you don't have to load from web
var channelPageTemplate = '<div class="channel-iap" id="channelScroller" style="overflow-y: scroll;"><div id="channelContent"><div id="head" onclick="switchNavOverlay()"><div class="header"><div class="channeltitle">[channelTitle]</div></div></div><div class="layout-a_region-3"><div class="inner"><div class="container">[channelContent]</div></div></div><div class="layout-a_region-4"><div class="inner"><div class="adiframe mpu loaded-in-view" type="250" frame="ad300x250"></div></div></div><div class="copyright"><b><font face="arial">© </font>英国金融时报</b> 有限公司 <font face="arial">2017</font>&nbsp;&nbsp;<span><acronym title="Financial Times">FT中文网</acronym>为英国金融时报的注册商标</span></div></div></div>';

var memberTemplate = '<div product-id="{{id}}" class="iap-item oneStory iap-member iap-member__{{type}}{{firstChildClass}} track-click" eventLabel="iap-detail: {{i}}">' +
    '<div class="headline">{{title}}</div>' +
    '<div class="coverIMG">' +
        '<img src="https://www.ft.com/__origami/service/image/v2/images/raw/{{image}}?source=ftchinese&width=840">' +
    '</div>' +
    '<ul class="iap-benefits">{{benefits}}</ul>' +
    '{{button}}' +   
'</div>' +
'<div class="clearfloat"></div>';

var gUserId = getCookie('USER_ID') || '';

// MARK: - Display all the iap products on the home page
function displayProductsOnHome(products) {
    // TODO: When displaying iap products on home, it should be grouped by type
    if (typeof products === 'object' && products.length > 0) {
        var productsHTML = getProductHTMLCode(products, 'all');
        if (document.getElementById('iap')) {
            document.getElementById('iap').innerHTML = productsHTML;
        }
        var iapChannelLinks = document.querySelectorAll('.iap-channel');
        for (var i = 0; i < iapChannelLinks.length; i++) {
            var iapClassName = iapChannelLinks[i].className.replace(' hide', '');
            iapChannelLinks[i].className = iapClassName;
        }

        // MARK: - Update the dimension of the home page navigation scroller so that the last items are displayed
        try {
            sectionScroller.updateDimensions();
        } catch (ignore) {
        }
    }
}

// MARK: - Create the HTML Code for iap Products to be displayed on home and channel pages
// MARK: - forGroup is used as filter to get only the specified iap type for channel page
function getProductHTMLCode(products, forGroup) {
    var productsHTML = '';
    var currentGroup = '';
    if (typeof products === 'object' && products.length > 0) {
        for (var i = 0; i < products.length; i++) {
            if (forGroup === 'all' || forGroup === products[i].group) {
                var firstChildClass = '';
                var productActionButton = '';
                var productPrice = products[i].price || '购买';
                var productBenefits = '';
                var benefitsArray = [];
                var productName = products[i].title || '';
                // MARK: If the forGroup is set to all, display all products in groups
                if (forGroup === 'all' && currentGroup !== products[i].group) {
                    currentGroup = products[i].group;
                    productsHTML += '<div class="section"><a class="iap-channel" iap-action="' + currentGroup + '" iap-title="' + products[i].groupTitle + '"><span>' + products[i].groupTitle + '</span></a><a href="restorepurchases://"><button class="floatright">恢复</button></a></div>';
                    firstChildClass = ' first-child';
                }
                if (products[i].expire) {
                    if (products[i].group === 'membership') {
                        // MARK: - Button HTML for membership
                        productActionButton = '<div class="iap-button" product-id="' + products[i].id + '" product-price="' + productPrice + '" product-title="' + productName + '"><p class="iap-teaser">您已订阅'+ productName +'，到期日为' + products[i].expire + '</p><a'+getBuyCode(products[i].id, productPrice, gUserId, productName)+'><button class="iap-move-left">续订</button></a></div>';
                    } else if (products[i].group === 'subscription') {
                        productActionButton = '';
                    }
                } else if (products[i].isDownloaded === true) {
                    productActionButton = '<div class="iap-button" product-id="' + products[i].id + '" product-price="' + productPrice + '" product-title="' + productName + '"><a href="readbook://' + products[i].id + '"><button class="iap-move-left">打开</button></a><a href="removedownload://' + products[i].id + '"><button>删除</button></a></div>';
                } else if (products[i].isPurchased === true) {
                    if (products[i].group === 'ebook') {
                        productActionButton = '<div class="iap-button" product-id="' + products[i].id + '" product-price="' + productPrice + '" product-title="' + productName + '"><a href="downloadproduct://' + products[i].id + '"><button>下载</button></a></div>';
                    } else if (products[i].group === 'membership') {
                        // MARK: - Button HTML for membership
                        productActionButton = '<div class="iap-button" product-id="' + products[i].id + '" product-price="' + productPrice + '" product-title="' + productName + '"><p class="iap-teaser">' + products[i].teaser + ' ' + products[i].price + '/年' + '</p><a'+getBuyCode(products[i].id, productPrice, gUserId, productName)+'><button class="iap-move-left">续订</button></a></div>';
                    } else if (products[i].group === 'subscription') {
                        productActionButton = '';
                    }
                } else {
                    if (products[i].group === 'ebook' || products[i].group === 'subscription') {
                        productActionButton = '<div class="iap-button" product-id="' + products[i].id + '" product-price="' + productPrice + '" product-title="' + productName + '"><button onclick="showProductDetail(\'' + products[i].id + '\');" class="iap-detail">查看</button><a'+getBuyCode(products[i].id, productPrice, gUserId, productName)+'><button class="iap-move-left">' + productPrice + '</button></a></div>';
                    } else if (products[i].group === 'membership') {
                        // MARK: - Button HTML for membership
                        productActionButton = '<div class="iap-button" product-id="' + products[i].id + '" product-price="' + productPrice + '" product-title="' + productName + '"><p class="iap-teaser">' + products[i].teaser + ' ' + products[i].price + '/年' + '</p><a'+getBuyCode(products[i].id, productPrice, gUserId, productName)+'><button class="iap-move-left">现在订阅</button></a></div>';
                    }
                }
                // MARK: - use onclick to capture click rather than jQuery's body.on, which is buggy on iPhone
                if (products[i].group === 'membership') {
                    benefitsArray = products[i].benefits;
                    if (Array.isArray(benefitsArray) && benefitsArray.length > 0) {
                        for (var j = 0; j < benefitsArray.length; j++) {
                            productBenefits += '<li>' + benefitsArray[j] + '</li>';
                        }
                    }
                    // productsHTML += '<div product-id="' + products[i].id + '" class="iap-item oneStory iap-member' + firstChildClass + ' track-click" eventLabel="iap-detail: ' + i + '"><div><div class="headline">' + products[i].title + '</div><div class="coverIMG"><img src="https://www.ft.com/__origami/service/image/v2/images/raw/' + products[i].image + '?source=ftchinese&width=840"></div><ul class="iap-benefits">' + productBenefits + '</ul></div></div>' + productActionButton + '<div class=clearfloat></div>';
                    var memberType = products[i].id.split('.').pop();
                    productsHTML += memberTemplate
                        .replace('{{id}}', products[i].id)
                        .replace('{{type}}', memberType)
                        .replace('{{firstChildClass}}', firstChildClass)
                        .replace('{{i}}', i)
                        .replace('{{title}}', products[i].title)
                        .replace('{{image}}', products[i].image)
                        .replace('{{benefits}}', productBenefits)
                        .replace('{{button}}', productActionButton);

                } else {
                    productsHTML += '<div product-id="' + products[i].id + '" product-price="' + productPrice + '" product-title="' + productName + '" class="iap-item oneStory' + firstChildClass + ' track-click" eventLabel="iap-detail: ' + i + '"><div onclick="showProductDetail(\'' + products[i].id + '\');"><img src="https://www.ft.com/__origami/service/image/v2/images/raw/' + products[i].image + '?source=ftchinese&width=160" class=leftimage width="80"><div class="headline">' + products[i].title + '</div><div class=lead>' + products[i].teaser + '</div></div>' + productActionButton + '<div class=clearfloat></div></div>';
                }
            }
        }
    }
    return productsHTML;
}

// MARK: - extract product information and display it to home or channel page
function displayProducts(products, page, pageTitle) {
    if (typeof products === 'object' && products.length > 0) {
        // TODO: Page should be used as a filter, for example, "ebook" should be used to extra only the eBooks from the iapProducts


        var productsHTML = getProductHTMLCode(products, page);
        // MARK: - if page is not 'home', then we should open channel view
        if (page !== '') {
            var channelHTML = channelPageTemplate
                .replace('[channelContent]', productsHTML)
                .replace('[channelTitle]', pageTitle);
            var channelView = $('#channelview');
            channelView.html(channelHTML);
            document.getElementById('header-title').innerHTML = pageTitle;
            closeOverlay();
            document.body.className = 'channelview channel-iap';
            gNowView = 'channelview';
            if (useFTScroller === 0) {
                window.scrollTo(0, 0);
            }
            // MARK: - Send Traffic Data so that this can be tracked
            var url = gDeviceType + '/channelpage/iap/' + page;
            httpspv(url);
            // MARK: 记录频道页浏览历史
            if (hist && ((hist[0] && hist[0].url != url) || hist.length == 0)) {
                hist.unshift({ 'url': '/channelpage/iap/' + page, 'title': pageTitle });
            }
        }
    }
}

// MARK: - Open the product detail page so that user can buy, download and use the product
function showProductDetail(productId) {
    // MARK: - Get current product information
    var currentProduct;
    if (typeof iapProducts === 'object' && iapProducts.length > 0) {
        for (var i = 0; i < iapProducts.length; i++) {
            if (iapProducts[i].id === productId) {
                currentProduct = iapProducts[i];
                break;
            }
        }
    }
    // MARK: - Display the story view
    if (typeof currentProduct === 'object') {
        // MARK: - Calculate Product Information
        var storyView = document.getElementById('storyview');
        var imageHTML = '<div class="leftPic imageloaded"><img src="https://www.ft.com/__origami/service/image/v2/images/raw/' + currentProduct.image + '?source=ftchinese&width=414"></div>';

        // MARK: - Get iap-rail Dom innerHTML to display two buttons at the bottom of product detail 
        var iapRailHTML = '';
        if (currentProduct.isPurchased === false && currentProduct.isDownloaded === false) {
            iapRailHTML = '<a'+getBuyCode(currentProduct.id, currentProduct.price, gUserId, currentProduct.title)+'><button class="floatright iap-highlight">购买：' + currentProduct.price + '</button></a><a href="try://' + currentProduct.id + '"><button class="floatleft">试读</button></a>';
        } else if (currentProduct.isPurchased === true && currentProduct.isDownloaded === false) {
            iapRailHTML = '<a href="downloadproduct://' + currentProduct.id + '"><button class="full-width iap-highlight">下载</button></a>';
        } else if (currentProduct.isPurchased === true && currentProduct.isDownloaded === true) {
            iapRailHTML = '<a href="readbook://' + currentProduct.id + '"><button class="floatright iap-highlight">打开</button></a><a href="removedownload://' + currentProduct.id + '"><button class="floatleft">删除</button></a>';
        }

        // MARK: - Update Dom here
        storyView.querySelector('.storydate').innerHTML = '';
        storyView.querySelector('.storybyline').innerHTML = '';
        storyView.querySelector('.storytitle').innerHTML = currentProduct.title;
        document.getElementById('bodytext').innerHTML = imageHTML + currentProduct.description;
        document.getElementById('header-title').innerHTML = currentProduct.groupTitle || '';

        // MARK: - Update the iap-rail Button
        document.getElementById('iap-rail').innerHTML = iapRailHTML;
        document.getElementById('iap-rail').setAttribute('data-id', productId);
        document.getElementById('iap-rail').setAttribute('data-price', currentProduct.price);

        // MARK: - Display the storyview by changing the className of body
        document.body.className = 'storyview story-iap';
        gNowView = 'storyview';
        addStoryScroller();

        // MARK: - Send Traffic Data so that this can be tracked
        httpspv(gDeviceType + '/storypage/iap' + productId);

        // MARK: update the hist array so that it can be swiped back
        if (hist && ((hist[0] && hist[0].url != 'story/' + productId) || hist.length == 0)) {
            hist.unshift({ 'url': 'story/' + productId, 'title': currentProduct.title });
        }
    }
}

// MARK: - Update window.iapProducts after user act on any one of the products
function updateProductStatus(productIndex, isProductPurchased, isProductDownloaded) {
    if (productIndex >= 0 && window.iapProducts[productIndex]) {
        window.iapProducts[productIndex].isPurchased = isProductPurchased;
        window.iapProducts[productIndex].isDownloaded = isProductDownloaded;
    }
}


function getViewPrefix() {
    var viewPrefix = '';
    if (gNowView.indexOf('storyview') >= 0) {
        viewPrefix = 'story-';
    } else if (gNowView.indexOf('channelview') >= 0) {
        viewPrefix = 'channel-';
    }
    return viewPrefix;
}

// MARK: - Update DOM UI based on user actions
function iapActions(productID, actionType, expireDate) {
    var iapButtons;
    var iapRailHTML = '';
    var iapHTMLCode = '';
    var productPrice = '';
    var productTeaser = '';
    var productIndex;
    var productName;
    var productExpire = '为止';

    // MARK: - current view prefix
    var viewPrefix = getViewPrefix();

    // MARK: get iapButtons based on the current view
    var currentView = 'fullbody';
    if (gNowView.indexOf('storyview') >= 0) {
        currentView = 'storyview';
    } else if (gNowView.indexOf('channelview') >= 0) {
        currentView = 'channelview';
    }

    iapButtons = document.getElementById(currentView).querySelectorAll('.iap-button');

    // MARK: - Get the index number of the current product for window.iapProducts
    if (productID !== '') {
        for (var i = 0; i < window.iapProducts.length; i++) {
            if (productID === iapProducts[i].id) {
                productIndex = i;
                break;
            }
        }
    }

    // MARK: - get product price here
    productPrice = window.iapProducts[productIndex].price || '购买';
    productTeaser = window.iapProducts[productIndex].teaser || '';
    productName = window.iapProducts[productIndex].title || '';

    // MARK: - Get product type based on its identifiers
    var productType = '';
    if (/premium$|standard$|trial$/.test(productID)) {
        productType = 'membership';
    } else if (/subscription/.test(productID)) {
        productType = 'subscription';
    } else {
        productType = 'eBook';
    }

    // MARK: - iapHTMLCode is used for home and channel page, iapRailHTML is used for product detail page
    switch (actionType) {
        case 'success':
            if (productType === 'membership') {
                productExpire = expireDate || '未知';
                iapHTMLCode = '<p class="iap-teaser">成功订阅'+productName+'，到期时间'+productExpire+'</p><a'+getBuyCode(productID, productPrice, gUserId, productName)+'><button class="iap-move-left">续订</button></a>';
                iapRailHTML = '';
            } else {
                iapHTMLCode = '<a href="readbook://' + productID + '"><button class="iap-move-left">打开</button></a><a href="removedownload://' + productID + '"><button>删除</button></a>';
                iapRailHTML = '<a href="readbook://' + productID + '"><button class="floatright iap-highlight">打开</button></a><a href="removedownload://' + productID + '"><button class="floatleft">删除</button></a>';
            }
            updateProductStatus(productIndex, true, true);
            break;
        case 'pendingdownload':
            iapHTMLCode = '<a href="downloadproduct://' + productID + '"><button>下载</button></a>';
            iapRailHTML = '<a href="downloadproduct://' + productID + '"><button class="full-width iap-highlight">下载</button></a>';
            updateProductStatus(productIndex, true, false);
            break;
        case 'downloading':
            iapHTMLCode = '<a id="' + viewPrefix + 'pause-' + productID + '" href="pausedownload://' + productID + '"><button class="iap-move-left pause-button">暂停</button></a><a href="canceldownload://' + productID + '"><button>取消</button></a><div class="progresscontainer"><div class="progressbar standardprogressbar uses3d progressbg structureprogress" id="' + viewPrefix + 'progress-' + productID + '"></div></div><div id="' + viewPrefix + 'status-' + productID + '" class="download-status"></div>';
            iapRailHTML = '<a href="canceldownload://' + productID + '"><button class="quarter-width floatright">取消</button></a><a id="story-pause-' + productID + '" href="pausedownload://' + productID + '"><button class="pause-button quarter-width floatright">暂停</button></a><div class="progresscontainer"><div class="progressbar standardprogressbar uses3d progressbg structureprogress" id="' + viewPrefix + 'progress-' + productID + '"></div></div><div id="' + viewPrefix + 'status-' + productID + '" class="download-status"></div>';
            updateProductStatus(productIndex, true, false);
            break;
        case 'pending':
            if (productType === 'membership') {
                iapHTMLCode = '<p class="iap-teaser">请求...</p>';
                iapRailHTML = '';
            } else {
                iapHTMLCode = '<button>请求...</button>';
                iapRailHTML = '<button class="full-width">请求...</button>';
            }
            updateProductStatus(productIndex, false, false);
            break;
        case 'fail':
            if (productType === 'membership') {
                iapHTMLCode = '<p class="iap-teaser">' + productTeaser + ' ' + productPrice + '/年' + '</p><a'+getBuyCode(productID, productPrice, gUserId, productName)+'><button class="iap-move-left">立即订阅</button></a>';
                iapRailHTML = '';
            } else {
            iapHTMLCode = '<a'+getBuyCode(productID, productPrice, gUserId, productName)+'><button class="iap-move-left">' + productPrice + '</button></a><button onclick="showProductDetail(\'' + productID + '\');" class="iap-detail">查看</button>';
            iapRailHTML = '<a'+getBuyCode(productID, productPrice, gUserId, productName)+'><button class="floatright iap-highlight">购买：' + productPrice + '</button></a><a href="try://' + productID + '"><button class="floatleft">试读</button></a>';
            }
            updateProductStatus(productIndex, false, false);


            //productActionButton = '<div class="iap-button" product-id="' + products[i].id + '" product-price="' + productPrice + '"></div>';


            break;
        default:
    }

    // MARK: - for each of the iap button containers that fit the criteria, update its innerHTML
    for (var i = 0; i < iapButtons.length; i++) {
        //productPrice = iapButtons[i].getAttribute('product-price') || '购买';
        if (productID === iapButtons[i].getAttribute('product-id')) {
            //iapHTMLCode = iapHTMLCode.replace('[productprice]',productPrice);
            iapButtons[i].innerHTML = iapHTMLCode;
        } else if (productID === '') {
            iapHTMLCode = '<a'+getBuyCode(iapButtons[i].getAttribute('product-id'), iapButtons[i].getAttribute('product-price'), gUserId, iapButtons[i].getAttribute('product-title'))+'><a href="buy://' + iapButtons[i].getAttribute('product-id') + '"><button class="iap-move-left">' + productPrice + '</button></a><button onclick="showProductDetail(\'' + products[i].id + '\');" class="iap-detail">查看</button>';
            iapButtons[i].innerHTML = iapHTMLCode;
        }
    }

    // Mark: Update iap Button at the bottom of the detail view
    if (productID !== '' && document.getElementById('iap-rail').getAttribute('data-id') === productID && gNowView.indexOf('storyview') >= 0) {
        document.getElementById('iap-rail').innerHTML = iapRailHTML;
    }

}

// MARK: - Update download progress and status based on the current view
function updateDownloadProgress(productID, barPercentage, progressStatus) {
    if (gNowView.indexOf('storyview') >= 0) {
        document.getElementById('story-progress-' + productID).style.width = barPercentage;
        document.getElementById('story-status-' + productID).innerHTML = progressStatus;
    } else {
        // TODO: need to update progress bars in both home and channel pages
        var viewPrefix = getViewPrefix();
        document.getElementById(viewPrefix + 'progress-' + productID).style.width = barPercentage;
        document.getElementById(viewPrefix + 'status-' + productID).innerHTML = progressStatus;
    }
}

// MARK: - Update download pause button based on user interaction
function updateDownloadPauseButton(productID, action) {
    var pauseButton;
    var viewPrefix = getViewPrefix();
    pauseButton = document.getElementById(viewPrefix + 'pause-' + productID);

    var newAction;
    var newHref;
    if (action === 'pause') {
        newAction = '继续';
        newHref = 'resumedownload://' + productID;
    } else {
        newAction = '暂停';
        newHref = 'pausedownload://' + productID;
    }

    pauseButton.querySelector('.pause-button').innerHTML = newAction;
    pauseButton.setAttribute('href', newHref);
}

// MARK: - Get url scheme for iOS buy and JS onclick code for Android
function getBuyCode(productId, productPrice, userId, productName) {
    var buyCode = '';
    var priceForAndroid = productPrice.replace(/[^(0-9\.)]/g,'');
    if(osVersion.indexOf("Android")<0){
        buyCode = ' href="buy://' + productId + '"';
    } else {
        buyCode = ' onclick="ftjavacriptapp.payzfb(\''+ productId +'\',\''+ priceForAndroid +'\',\''+ userId +'\',\''+ productName +'\')"';
    }
    return buyCode;
}